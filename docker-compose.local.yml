# docker-compose -f docker-compose.yml -f docker-compose.local.yml up -d --build

# edit (eg. gateway): docker-compose -f docker-compose.yml -f docker-compose.local.yml up -d --force-recreate gateway
services:
  logging-service:
    build:
      context: src/Services/LoggingService/
      dockerfile: src/LoggingService.API/Dockerfile
    container_name: simpitch-logging
    ports:
      - "${LOGGING_SERVICE_HOST_PORT_GRPC:-5001}:${LOGGING_SERVICE_CONTAINER_PORT_GRPC:-5001}"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://+:${LOGGING_SERVICE_CONTAINER_PORT_GRPC:-5001}
      - ConnectionStrings__LoggingDb=Server=mssql;Database=LoggingDb;User Id=${DB_ADMIN};Password=${DB_PASSWORD};Encrypt=True;TrustServerCertificate=True;MultipleActiveResultSets=True;Connection Timeout=30;
    depends_on:
      - mssql

  engine-service:
    build:
      context: src/Services/EngineService/
      dockerfile: src/EngineService.API/Dockerfile
    container_name: simpitch-engine
    ports:
      - "${ENGINE_SERVICE_HOST_PORT_REST:-5002}:${ENGINE_SERVICE_CONTAINER_PORT_REST:-5002}"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://+:${ENGINE_SERVICE_CONTAINER_PORT_REST:-5002}
      - ConnectionStrings__EngineDb=Server=mssql;Database=EngineDb;User Id=${DB_ADMIN};Password=${DB_PASSWORD};Encrypt=True;TrustServerCertificate=True;MultipleActiveResultSets=True;Connection Timeout=30;
      - GrpcLogging__Address=http://logging-service:${LOGGING_SERVICE_CONTAINER_PORT_GRPC:-5001}
      - GrpcLogging__SourceName=EngineService
      - SimulationService__Address=http://simulation-service:${SIMULATION_SERVICE_CONTAINER_PORT_GRPC:-5003}
      - StatisticsService__Address=http://statistics-service:${STATISTICS_SERVICE_CONTAINER_PORT_GRPC:-5004}
    depends_on:
      - mssql
      - logging-service
      - simulation-service
      - statistics-service

  sportsdata-service:
    build:
      context: src/Services/SportsDataService/
      dockerfile: src/SportsDataService.API/Dockerfile
    container_name: simpitch-sportsdata
    ports:
      - "${SPORTSDATA_SERVICE_HOST_PORT_REST:-5005}:${SPORTSDATA_SERVICE_CONTAINER_PORT_REST:-5005}"
      - "${SPORTSDATA_SERVICE_HOST_PORT_GRPC:-5006}:${SPORTSDATA_SERVICE_CONTAINER_PORT_GRPC:-5006}"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ConnectionStrings__SportsDataDb=Server=mssql;Database=SportsDataDb;User Id=${DB_ADMIN};Password=${DB_PASSWORD};Encrypt=True;TrustServerCertificate=True;MultipleActiveResultSets=True;Connection Timeout=30;
      - GrpcLogging__Address=http://logging-service:${LOGGING_SERVICE_CONTAINER_PORT_GRPC:-5001}
      - GrpcLogging__SourceName=SportsDataService
      - ConnectionStrings__Redis=${REDIS_CONN_STRING}
    depends_on:
      - mssql
      - logging-service

  simulation-service:
    build:
      context: src/Services/SimulationService/
      dockerfile: src/SimulationService.API/Dockerfile
    container_name: simpitch-simulation
    ports:
      - "${SIMULATION_SERVICE_HOST_PORT_GRPC:-5003}:${SIMULATION_SERVICE_CONTAINER_PORT_GRPC:-5003}"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://+:${SIMULATION_SERVICE_CONTAINER_PORT_GRPC:-5003}
      - ConnectionStrings__SimulationDb=Server=mssql;Database=SimulationDb;User Id=${DB_ADMIN};Password=${DB_PASSWORD};Encrypt=True;TrustServerCertificate=True;MultipleActiveResultSets=True;Connection Timeout=30;
      - ConnectionStrings__Redis=${REDIS_CONN_STRING}
      - GrpcLogging__Address=http://logging-service:${LOGGING_SERVICE_CONTAINER_PORT_GRPC:-5001}
      - GrpcLogging__SourceName=SimulationService
      - SportsDataService__Address=http://sportsdata-service:${SPORTSDATA_SERVICE_CONTAINER_PORT_GRPC:-5006}
      - StatisticsService__Address=http://statistics-service:${STATISTICS_SERVICE_CONTAINER_PORT_GRPC:-5004}
    depends_on:
      - mssql
      - logging-service

  statistics-service:
    build:
      context: src/Services/StatisticsService/
      dockerfile: src/StatisticsService.API/Dockerfile
    container_name: simpitch-statistics
    ports:
      - "${STATISTICS_SERVICE_HOST_PORT_GRPC:-5004}:${STATISTICS_SERVICE_CONTAINER_PORT_GRPC:-5004}"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://+:${STATISTICS_SERVICE_CONTAINER_PORT_GRPC:-5004}
      - ConnectionStrings__StatisticsDb=Server=mssql;Database=StatisticsDb;User Id=${DB_ADMIN};Password=${DB_PASSWORD};Encrypt=True;TrustServerCertificate=True;MultipleActiveResultSets=True;Connection Timeout=30;
      - GrpcLogging__Address=http://logging-service:${LOGGING_SERVICE_CONTAINER_PORT_GRPC:-5001}
      - GrpcLogging__SourceName=StatisticsService
      - SportsDataService__Address=http://sportsdata-service:${SPORTSDATA_SERVICE_CONTAINER_PORT_GRPC:-5006}
      - SimulationService__Address=http://simulation-service:${SIMULATION_SERVICE_CONTAINER_PORT_GRPC:-5003}
    depends_on:
      - mssql
      - logging-service

  frontend:
    build:
      context: ./src/Frontend/sim-pitch-web
      dockerfile: Dockerfile.dev
    container_name: simpitchweb
    ports:
      - "${WEB_DEV_PORT:-5173}:${WEB_DEV_PORT:-5173}"
    environment:
      - NODE_ENV=development
      - VITE_API_TARGET=${VITE_API_TARGET}
      - DOCKER_ENV=true
      - HMR_HOST=localhost
    command: npm run dev -- --host --port ${WEB_DEV_PORT:-5173}
    restart: unless-stopped
    depends_on:
      - logging-service

  gateway:
    container_name: nginx-gateway
    ports:
      - "${GATEWAY_HOST_PORT:-8080}:${GATEWAY_SERVICE_CONTAINER_PORT:-80}"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - engine-service
      - logging-service
      - statistics-service
      - simulation-service
    restart: unless-stopped

  redis-cache:
    container_name: redis-service
    restart: always
    ports:
      - "${REDIS_PORT:-6379}:${REDIS_PORT:-6379}"
    command: redis-server --save 20 1 --loglevel warning --requirepass ${REDIS_PASS}
    volumes:
      - cache:/data

  mssql:
    container_name: simpitch-mssql
    ports:
      - "1433:1433"
    volumes:
      - mssql_data:/var/opt/mssql
      - ./sql/init.sql:/tmp/init.sql
    restart: no

  mssql-init:
    entrypoint: >
      /bin/bash -c "
        echo 'Waiting for SQL Server...';
        sleep 3;
        /opt/mssql-tools/bin/sqlcmd -S mssql -U ${DB_ADMIN} -P ${DB_PASSWORD} -d master -i /tmp/init.sql;
      "
    volumes:
      - ./sql/init.sql:/tmp/init.sql
    depends_on:
      - mssql

  seed-data:
    environment:
      - DB_ADMIN=${DB_ADMIN}
      - SA_PASSWORD=${DB_PASSWORD}
      - SEED_DATA=${SEED_DATA}
    depends_on:
      - mssql
      - mssql-init
